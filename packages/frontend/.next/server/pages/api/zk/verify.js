"use strict";(()=>{var e={};e.id=857,e.ids=[857],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},4770:e=>{e.exports=require("crypto")},6119:e=>{e.exports=require("perf_hooks")},4637:e=>{e.exports=import("snarkjs")},8037:(e,r,i)=>{i.r(r),i.d(r,{config:()=>x,default:()=>I,routeModule:()=>P});var t={};i.r(t),i.d(t,{default:()=>y});var s=i(9150),o=i(1631),a=i(6835),n=i(4673),d=i(5966),u=i(6119),l=i(5079),c=i(8700),f=i(2030),m=i(7041),p=i(2894);let v=new l.p;v.defaultRateLimit.maxRequestsPerMinute=30,v.defaultRateLimit.maxRequestsPerHour=300;let g={"dev-test-key":{maxRequestsPerMinute:60,maxRequestsPerHour:1e3,user:"developer"}};async function y(e,r){if(r.setHeader("Access-Control-Allow-Origin","*"),r.setHeader("Access-Control-Allow-Methods","POST, OPTIONS"),r.setHeader("Access-Control-Allow-Headers","Content-Type, X-API-Key, X-User-Id, X-Operation-Id"),"OPTIONS"===e.method)return r.status(200).end();if("POST"!==e.method)return r.status(405).json({error:"Method not allowed",allowedMethods:["POST"]});let i=u.performance.now(),t=e.headers["x-operation-id"]||`verify_${Date.now()}_${Math.random().toString(16).slice(2)}`;try{let{verificationKey:s,publicSignals:o,proof:a,nonce:l,timestamp:y}=e.body;if(!s||!o||!a)return r.status(400).json({error:"Missing required parameters",requiredParams:["verificationKey","publicSignals","proof"]});let I=m.t.sanitizeInput(a);if(m.t.sanitizeInput(o),!I.pi_a||!I.pi_b||!I.pi_c)return r.status(400).json({error:"Invalid proof format",message:"Proof must contain pi_a, pi_b, and pi_c components"});if(!l)return r.status(400).json({error:"Missing required parameter",message:"Nonce is required to prevent replay attacks",requiredParams:["nonce"]});let x=e.headers["x-user-id"]||e.query.userId||e.cookies?.userId||e.headers["x-forwarded-for"]||e.socket.remoteAddress||"anonymous",P=c.I.validateNonce(l,x,y||Date.now());if(!P.valid)return r.status(400).json({error:"Invalid nonce",message:P.message,reason:P.reason});if(e.body.signature){let i={signature:e.body.signature,timestamp:e.body.timestamp||Date.now().toString(),clientId:e.body.clientId||x},{signature:t,...s}=e.body,o=f.Y.verifyClientSignature(s,i);if(!o.valid)return r.status(401).json({error:"Invalid signature",message:o.message,reason:o.reason})}let h="true"===process.env.REQUIRE_API_KEY?function(e){let r=e.headers["x-api-key"]||e.query.apiKey;if(!r)return{valid:!1,error:"No API key provided"};let i=g[r];return i?{valid:!0,userId:i.user,limits:{maxRequestsPerMinute:i.maxRequestsPerMinute,maxRequestsPerHour:i.maxRequestsPerHour}}:{valid:!1,error:"Invalid API key"}}(e):{valid:!0,userId:x};if(!h.valid)return r.status(401).json({error:"Unauthorized",message:h.error});h.limits&&v.setUserLimits(h.userId||x,h.limits);let w=v.checkRateLimit(h.userId||x);if(!w.allowed)return r.status(429).json({error:"Too many requests",message:"Rate limit exceeded. Please try again later.",retryAfter:Math.ceil((w.minuteLimit.reset-Date.now())/1e3),limits:w});let k=function(e){let{verificationKey:r,publicSignals:i,proof:t}=e;return r?i?t?t.pi_a&&t.pi_b&&t.pi_c?r.protocol?{valid:!0}:{valid:!1,error:"Invalid verification key format"}:{valid:!1,error:"Invalid proof format"}:{valid:!1,error:"Missing proof"}:{valid:!1,error:"Missing public signals"}:{valid:!1,error:"Missing verification key"}}({verificationKey:s,publicSignals:o,proof:a});if(!k.valid)return r.status(400).json({error:"Invalid input",message:k.error});if(!n.s.isInitialized()&&!await n.s.initialize({serverSide:!0,maxRetries:3}))return d.X.recordError("verify-api","Failed to initialize snarkjs"),v.releaseRequest(h.userId||x),r.status(500).json({error:"Failed to initialize verification environment",operationId:t});let q=!1;try{n.s.isInitialized()||await n.s.initialize({serverSide:!0,timeout:1e4,maxRetries:3});let e=n.s.getSnarkjs();if(!e||!e.groth16||"function"!=typeof e.groth16.verify)throw Error("snarkjs not properly initialized or missing verify functionality");if(null==(q=await e.groth16.verify(s,o,a)))throw Error("Verification returned undefined result");d.X.recordOperation({operation:"verify-success",executionTimeMs:u.performance.now()-i,serverSide:!0,success:!!q,additionalInfo:{operationId:t}})}catch(e){return console.error("Verification error:",e.message,{error:e,operationId:t,hasVerificationKey:!!s,publicSignalsLength:o?.length,proofStructure:a?Object.keys(a):null}),d.X.recordError("verify-operation",e.message),r.status(400).json({verified:!1,error:`Verification failed: ${e.message}`,operationId:t})}let j=u.performance.now()-i;v.releaseRequest(h.userId||x),d.X.recordOperation({operation:"verify",executionTimeMs:j,serverSide:!0,success:!0,additionalInfo:{operationId:t,verified:q}});let R={verified:q,executionTimeMs:j,serverTiming:{totalTime:j},operationId:t},M=p.s.signResponse(R);return r.status(200).json(M)}catch(e){return console.error("Unexpected error in verify API:",e),d.X.recordError("verify-api",e.message||"Unknown error during verification"),r.status(500).json({error:"Verification failed",message:e.message||"Unknown error during verification",operationId:t})}}let I=(0,a.l)(t,"default"),x=(0,a.l)(t,"config"),P=new s.PagesAPIRouteModule({definition:{kind:o.x.PAGES_API,page:"/api/zk/verify",pathname:"/api/zk/verify",bundlePath:"",filename:""},userland:t})}};var r=require("../../../webpack-api-runtime.js");r.C(e);var i=e=>r(r.s=e),t=r.X(0,[257],()=>i(8037));module.exports=t})();