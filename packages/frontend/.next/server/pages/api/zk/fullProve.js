"use strict";(()=>{var e={};e.id=365,e.ids=[365],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},4770:e=>{e.exports=require("crypto")},2048:e=>{e.exports=require("fs")},6119:e=>{e.exports=require("perf_hooks")},4637:e=>{e.exports=import("snarkjs")},4066:(e,r,o)=>{let t;o.r(r),o.d(r,{config:()=>h,default:()=>I,routeModule:()=>A});var s={};o.r(s),o.d(s,{default:()=>w});var a=o(9150),i=o(1631),n=o(6835),l=o(4673),u=o(5966),d=o(6119),c=o(5079),m=o(8700),f=o(2030),p=o(7041),g=o(2894);try{t=o(5468)}catch(e){console.warn("Analytics client could not be loaded:",e.message),t=null}let v=new c.p,y={"dev-test-key":{maxRequestsPerMinute:30,maxRequestsPerHour:500,user:"developer"}},P={0:["walletAddress","amount"],1:["walletAddress","amount","threshold"],2:["walletAddress","amount","maximum"]};async function w(e,r){if(r.setHeader("Access-Control-Allow-Origin","*"),r.setHeader("Access-Control-Allow-Methods","POST, OPTIONS"),r.setHeader("Access-Control-Allow-Headers","Content-Type, X-API-Key, X-User-Id, X-Operation-Id"),"OPTIONS"===e.method)return r.status(200).end();if("POST"!==e.method)return r.status(405).json({error:"Method not allowed",allowedMethods:["POST"]});let s=d.performance.now(),a=e.headers["x-operation-id"]||`op_${Date.now()}_${Math.random().toString(16).slice(2)}`;try{let i,n;let{input:c,circuitWasmPath:w,zkeyPath:I,options:h={},clientInfo:A={},nonce:S,timestamp:x}=e.body;if(!c||!w||!I)return r.status(400).json({error:"Missing required parameters",requiredParams:["input","circuitWasmPath","zkeyPath"]});let k=p.t.sanitizeInput(c),q=p.t.validateProofInput(k);if(!q.valid)return r.status(400).json({error:"Invalid input parameters",validationErrors:q.errors,message:q.errors.map(e=>e.message).join("; ")});if(!S)return r.status(400).json({error:"Missing required parameter",message:"Nonce is required to prevent replay attacks",requiredParams:["nonce"]});let j=e.headers["x-user-id"]||e.query.userId||e.cookies?.userId||e.headers["x-forwarded-for"]||e.socket.remoteAddress||"anonymous",T=m.I.validateNonce(S,j,x||Date.now());if(!T.valid)return r.status(400).json({error:"Invalid nonce",message:T.message,reason:T.reason});if(e.body.signature){let o={signature:e.body.signature,timestamp:e.body.timestamp||Date.now().toString(),clientId:e.body.clientId||j},{signature:t,...s}=e.body,a=f.Y.verifyClientSignature(s,o);if(!a.valid)return r.status(401).json({error:"Invalid signature",message:a.message,reason:a.reason})}let b="true"===process.env.REQUIRE_API_KEY?function(e){let r=e.headers["x-api-key"]||e.query.apiKey;if(!r)return{valid:!1,error:"No API key provided"};let o=y[r];return o?{valid:!0,userId:o.user,limits:{maxRequestsPerMinute:o.maxRequestsPerMinute,maxRequestsPerHour:o.maxRequestsPerHour}}:{valid:!1,error:"Invalid API key"}}(e):{valid:!0,userId:j};if(!b.valid)return r.status(401).json({error:"Unauthorized",message:b.error});b.limits&&v.setUserLimits(b.userId||j,b.limits);let E=v.checkRateLimit(b.userId||j);if(!E.allowed)return r.status(429).json({error:"Too many requests",message:"Rate limit exceeded. Please try again later.",retryAfter:Math.ceil((E.minuteLimit.reset-Date.now())/1e3),limits:E});let M=function(e,r){if(void 0===r||!Number.isInteger(r)||r<0||r>2)return{valid:!1,error:"Invalid proof type, must be 0, 1, or 2"};let o=P[r];if(!o)return{valid:!1,error:`Unknown proof type: ${r}`};for(let r of o)if(void 0===e[r])return{valid:!1,error:`Missing required field: ${r}`};return/^(0x[a-fA-F0-9]{40}|[1-9A-HJ-NP-Za-km-z]{32,44})$/.test(e.walletAddress)?isNaN(e.amount)&&!/^\d+$/.test(e.amount)?{valid:!1,error:"Amount must be a number or numeric string"}:{valid:!0}:{valid:!1,error:"Invalid wallet address format"}}(c,c.proofType);if(!M.valid)return r.status(400).json({error:"Invalid input",message:M.error});if(A.userAgent&&console.log("Server-side fullProve request from:",{userAgent:A.userAgent,wasmSupported:A.wasmSupported,timestamp:A.timestamp||new Date().toISOString(),operationId:a}),!l.s.isInitialized()&&!await l.s.initialize({serverSide:!0,maxRetries:3}))return u.X.recordError("fullProve-api","Failed to initialize snarkjs"),r.status(500).json({error:"Failed to initialize proof generation environment"});let O=l.s.getSnarkjs();try{try{if(!w||"string"!=typeof w)throw Error("Invalid circuit WASM path");if(!I||"string"!=typeof I)throw Error("Invalid zkey path");let e=o(2048).promises;try{await e.access(w),await e.access(I)}catch(e){throw Error(`Circuit files not accessible: ${e.message}`)}let r=await O.groth16.fullProve(c,w,I,h);if(!r||!r.proof||!r.publicSignals)throw Error("Proof generation returned incomplete results");i=r.proof,n=r.publicSignals,console.log(`Proof generated successfully for operation ${a}`)}catch(e){return console.error("Proof generation error:",e.message,{error:e,operationId:a,circuitWasmPath:w,zkeyPath:I,inputKeys:Object.keys(c||{})}),u.X.recordError("fullProve-api",`Error generating real proof: ${e.message}`),r.status(500).json({error:"Proof generation failed",message:e.message,operationId:a,details:{errorType:e.name||"Unknown",errorTimestamp:new Date().toISOString()}})}}catch(e){return u.X.recordError("fullProve-api",`Proof generation failed: ${e.message}`),v.releaseRequest(b.userId||j),r.status(500).json({error:"Proof generation failed",message:e.message})}let R=d.performance.now()-s;if(v.releaseRequest(b.userId||j),u.X.recordOperation({operation:"fullProve",executionTimeMs:R,serverSide:!0,success:!0,additionalInfo:{operationId:a,proofType:c.proofType}}),t)try{t.logProofGeneration({operationId:a,proofType:c.proofType,network:A.network||"unknown",executionTimeMs:R,success:!0,clientType:A.clientType||"browser"})}catch(e){console.warn("Failed to log analytics:",e)}let z={proof:i,publicSignals:n,serverTiming:{totalTime:R},operationId:a,executionTimeMs:R},U=g.s.signResponse(z);return r.status(200).json(U)}catch(e){return console.error("Unexpected error in fullProve API:",e),u.X.recordError("fullProve-api",e.message||"Unknown error during proof generation"),r.status(500).json({error:"Proof generation failed",message:e.message||"Unknown error during proof generation",operationId:a})}}let I=(0,n.l)(s,"default"),h=(0,n.l)(s,"config"),A=new a.PagesAPIRouteModule({definition:{kind:i.x.PAGES_API,page:"/api/zk/fullProve",pathname:"/api/zk/fullProve",bundlePath:"",filename:""},userland:s})},5468:e=>{e.exports={logProofGeneration:function(e){try{console.log("[Analytics] Proof generation logged:",{timestamp:new Date().toISOString(),...e})}catch(e){console.error("[Analytics] Failed to log proof generation:",e)}},logProofVerification:function(e){try{console.log("[Analytics] Proof verification logged:",{timestamp:new Date().toISOString(),...e})}catch(e){console.error("[Analytics] Failed to log proof verification:",e)}},logError:function(e){try{console.error("[Analytics] Error logged:",{timestamp:new Date().toISOString(),...e})}catch(e){console.error("[Analytics] Failed to log error:",e)}},logUserEvent:function(e){try{console.log("[Analytics] User event logged:",{timestamp:new Date().toISOString(),...e})}catch(e){console.error("[Analytics] Failed to log user event:",e)}}}}};var r=require("../../../webpack-api-runtime.js");r.C(e);var o=e=>r(r.s=e),t=r.X(0,[257],()=>o(4066));module.exports=t})();